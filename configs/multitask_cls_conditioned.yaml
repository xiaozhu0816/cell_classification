# Multi-Task Learning with Classification-Conditioned Regression
# 
# This variant uses classification logits as additional input to the regression head,
# allowing the model to adapt its time prediction based on the predicted class.
#
# Architecture:
#   Image → Backbone → Features
#                      ├→ Classification Head → Class logits
#                      └→ Regression Head (Features + Class logits) → Time prediction
#
# Benefits:
#   - Regression head "knows" predicted class and can choose appropriate time reference
#   - May improve regression accuracy by reducing class-related ambiguity
#   - Adds minimal parameters (just input dimension increases by num_classes)

experiment_name: multitask_cls_conditioned
seed: 42

# ============ Data Configuration ============
data:
  infected_dir: "/isilon/datalake/gurcan_rsch/scratch/WSI/zhengjie/DATA/GMU_cell_1023/HBMVEC/Infected_well/no_labels"
  uninfected_dir: "/isilon/datalake/gurcan_rsch/scratch/WSI/zhengjie/DATA/GMU_cell_1023/HBMVEC/Uninfected_well/no_labels"
  
  infected_label: 1
  uninfected_label: 0
  
  split_ratios: [0.7, 0.1, 0.2]
  split_seed: 123
  
  batch_size: 128
  eval_batch_size_multiplier: 2
  num_workers: 4
  drop_last: false
  balance_sampler: false
  
  transforms:
    image_size: 512
    random_flip: true
    random_rotation: true
    color_jitter: false
    mean: [0.5, 0.5, 0.5]
    std: [0.25, 0.25, 0.25]
  
  frames:
    frames_per_hour: 2.0
    infected_window_hours: [1, 48]
    uninfected_window_hours: [0, 48]
    infected_stride: 1
    uninfected_stride: 1
    uninfected_use_all: true

# ============ Multi-Task Configuration ============
multitask:
  infection_onset_hour: 1.0
  clamp_range: [0.0, 48.0]
  classification_weight: 1.0
  regression_weight: 1.0

# ============ Model Configuration ============
model:
  name: resnet50
  pretrained: true
  num_classes: 2
  dropout: 0.2
  train_backbone: true
  hidden_dim: 256
  
  # ENABLED: Classification-conditioned regression
  use_cls_conditioning: true  # Regression head receives class logits

# ============ Training Configuration ============
training:
  epochs: 100
  amp: true
  grad_clip: 1.0
  checkpoint_dir: checkpoints

# ============ Optimizer Configuration ============
optimizer:
  lr: 0.0001
  weight_decay: 0.0001

# ============ Scheduler Configuration ============
scheduler:
  t_max: 30
  eta_min: 0.000001

# ============ How to Run ============
#
# Standard multitask:
#   python train_multitask_cv.py --config configs/multitask_example.yaml --num-folds 5
#
# With classification conditioning (this config):
#   python train_multitask_cv.py --config configs/multitask_cls_conditioned.yaml --num-folds 5
#
# Compare the two:
#   python compare_regression_performance.py \
#     --multitask outputs/multitask_resnet50/TIMESTAMP_5fold \
#     --regression-infected outputs/multitask_cls_conditioned/TIMESTAMP_5fold
